# Smart Contract Events Indexer

A comprehensive real-time event indexing solution for the Zali Trivia Game smart contract. This indexer enables live updates, historical data analysis, and advanced filtering capabilities for game events.

## Overview

The Events Indexer provides:

- **Real-time Event Listening**: WebSocket-based connection to Base Mainnet for instant event detection
- **Event Processing**: Typed handlers for QuestionAdded, AnswerSubmitted, and derived events
- **Persistent Storage**: IndexedDB for client-side persistence with in-memory caching
- **Live Updates**: Server-Sent Events (SSE) for pushing updates to connected clients
- **Query API**: RESTful endpoints for filtering and retrieving event data
- **Notifications**: Toast, browser, and sound notifications for game events
- **Health Monitoring**: Comprehensive health checks and metrics collection

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        Frontend (React)                          │
├─────────────────────────────────────────────────────────────────┤
│  Hooks                     │  Components                         │
│  - useEventStream          │  - EventHistory                     │
│  - useEvents               │  - EventAnalytics                   │
│  - useLeaderboard          │                                     │
│  - usePlayer               │                                     │
├─────────────────────────────────────────────────────────────────┤
│                        API Layer (Next.js)                       │
├─────────────────────────────────────────────────────────────────┤
│  /api/events               │  Query events with filtering        │
│  /api/events/stats         │  Get event statistics               │
│  /api/events/leaderboard   │  Get player rankings                │
│  /api/events/player/[addr] │  Get player details                 │
│  /api/events/stream        │  SSE event stream                   │
│  /api/events/health        │  Health check endpoint              │
├─────────────────────────────────────────────────────────────────┤
│                        Services Layer                            │
├─────────────────────────────────────────────────────────────────┤
│  EventListener      │  Connects to blockchain, parses events     │
│  EventHandlers      │  Processes events, updates storage         │
│  EventStorage       │  IndexedDB + memory cache                  │
│  WebSocketServer    │  SSE broadcaster for live updates          │
│  NotificationService│  Push notifications to users               │
│  RetryManager       │  Exponential backoff, circuit breaker      │
│  HealthCheck        │  System health monitoring                  │
└─────────────────────────────────────────────────────────────────┘
```

## Events Indexed

### Primary Events (from contract)

| Event | Description |
|-------|-------------|
| `QuestionAdded` | Emitted when a new trivia question is added |
| `AnswerSubmitted` | Emitted when a player submits an answer |

### Derived Events (generated by indexer)

| Event | Description |
|-------|-------------|
| `RewardDistributed` | Generated when a correct answer earns USDC |
| `ScoreUpdated` | Generated when a player's score changes |

## Installation

The indexer is integrated into the Next.js frontend. No additional installation required.

### Environment Variables

Add to `.env.local`:

```env
# Contract Configuration
NEXT_PUBLIC_CONTRACT_ADDRESS=0x7409Cbcb6577164E96A9b474efD4C32B9e17d59d
NEXT_PUBLIC_DEPLOYED_BLOCK=0

# RPC Configuration
NEXT_PUBLIC_RPC_URL=https://mainnet.base.org
NEXT_PUBLIC_WS_RPC_URL=wss://base-mainnet.g.alchemy.com/v2/YOUR_API_KEY

# Optional
NEXT_PUBLIC_USDC_ADDRESS=0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913
```

## Usage

### React Hooks

```tsx
import { useEventStream, useLeaderboard, usePlayer } from '@/hooks/useEventStream';

// Real-time event stream
function LiveEvents() {
  const { events, isConnected } = useEventStream({
    eventTypes: ['AnswerSubmitted'],
    autoConnect: true,
  });

  return (
    <div>
      {events.map(event => (
        <EventCard key={event.transactionHash} event={event} />
      ))}
    </div>
  );
}

// Leaderboard with live updates
function Leaderboard() {
  const { leaderboard, loading, isLive } = useLiveLeaderboard(10);

  return (
    <ul>
      {leaderboard.map(player => (
        <li key={player.address}>
          {player.rank}. {player.address}: {player.score} pts
        </li>
      ))}
    </ul>
  );
}

// Player profile
function PlayerProfile({ address }) {
  const { player, recentEvents, loading } = usePlayer(address);

  if (loading) return <Loading />;
  if (!player) return <NotFound />;

  return (
    <div>
      <h2>{player.address}</h2>
      <p>Score: {player.score}</p>
      <p>Accuracy: {player.accuracy}%</p>
    </div>
  );
}
```

### Components

```tsx
import { EventHistory, EventAnalytics } from '@/components/events';

// Event feed with filtering
<EventHistory maxEvents={50} showFilters autoScroll />

// Analytics dashboard
<EventAnalytics refreshInterval={30000} />
```

### API Endpoints

#### GET /api/events

Query events with filtering.

```bash
# Get all events
curl /api/events

# Filter by type
curl /api/events?eventTypes=AnswerSubmitted,QuestionAdded

# Filter by user
curl /api/events?user=0x1234...

# Filter by block range
curl /api/events?fromBlock=100000&toBlock=200000

# Pagination
curl /api/events?limit=50&offset=100
```

#### GET /api/events/stats

Get event and game statistics.

```bash
curl /api/events/stats
```

Response:
```json
{
  "success": true,
  "data": {
    "events": {
      "total": 1250,
      "byType": {
        "QuestionAdded": 50,
        "AnswerSubmitted": 1000
      },
      "last24h": 150,
      "lastHour": 25
    },
    "game": {
      "totalQuestions": 50,
      "totalAnswers": 1000,
      "correctRate": "65.50",
      "totalRewardsDistributed": "655000000",
      "uniquePlayers": 150
    }
  }
}
```

#### GET /api/events/leaderboard

Get ranked player list.

```bash
curl /api/events/leaderboard?limit=10
```

#### GET /api/events/player/[address]

Get player details and recent activity.

```bash
curl /api/events/player/0x1234567890123456789012345678901234567890
```

#### GET /api/events/stream

Subscribe to real-time events via SSE.

```javascript
const eventSource = new EventSource('/api/events/stream?eventTypes=AnswerSubmitted');

eventSource.onmessage = (event) => {
  const data = JSON.parse(event.data);
  console.log('New event:', data);
};
```

#### GET /api/events/health

Check system health.

```bash
curl /api/events/health
```

## Configuration

All configuration is centralized in `/src/config/indexer.ts`:

```typescript
import { getConfig } from '@/config/indexer';

const config = getConfig();

// Access specific settings
console.log(config.contract.address);
console.log(config.indexer.pollingInterval);
console.log(config.features.enableRealTimeUpdates);
```

## Error Handling

The indexer includes robust error handling:

- **Retry Logic**: Exponential backoff with configurable retries
- **Circuit Breaker**: Prevents cascade failures during outages
- **Error Aggregation**: Tracks error patterns for debugging

```typescript
import { ResilientExecutor } from '@/services/indexer/RetryManager';

const executor = new ResilientExecutor({
  maxRetries: 5,
  initialDelayMs: 1000,
});

const result = await executor.execute(async () => {
  // Your operation
});
```

## Health Monitoring

The health check service monitors:

- RPC connection status
- IndexedDB availability
- Memory usage
- Error rates
- Cache performance
- Active SSE connections

Access via API:
```bash
curl /api/events/health
```

## Performance

| Metric | Target | Notes |
|--------|--------|-------|
| Event Processing | < 10ms | Per event handler execution |
| API Response | < 100ms | For typical queries |
| Memory Usage | < 50MB | Client-side IndexedDB cache |
| SSE Latency | < 500ms | Event to client delivery |

## Development

### Running Tests

```bash
npm run test
```

### Debug Logging

Enable in development:
```typescript
// config/indexer.ts
FEATURE_FLAGS.enableDebugLogging = true;
```

### Adding New Event Types

1. Add type definition in `/types/events.ts`
2. Create handler in `/services/indexer/EventHandlers.ts`
3. Register handler in `EventHandlerDispatcher`
4. Add notification in `NotificationService`

## Troubleshooting

### Events Not Appearing

1. Check RPC connection: `curl /api/events/health`
2. Verify contract address in config
3. Check browser console for errors
4. Ensure IndexedDB is enabled

### SSE Connection Drops

1. Check network stability
2. Review heartbeat interval settings
3. Check for proxy/firewall issues
4. Monitor error rates in health endpoint

### High Memory Usage

1. Reduce `maxEventsInMemory` in config
2. Clear old IndexedDB data
3. Reduce event retention period

## License

MIT
